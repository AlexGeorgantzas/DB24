-- Drop tables if they exist to avoid errors
SET FOREIGN_KEY_CHECKS = 0;

-- Drop tables in order of dependency (least dependent first)
DROP TABLE IF EXISTS recipe_img, label_recipe, meal_recipe, steps, episode, ep_info;
DROP TABLE IF EXISTS recipe, user_table, label, meal_type;
DROP TABLE IF EXISTS ingredient, equipment;
DROP TABLE IF EXISTS images, food_group, user_group, cook, national_cuisine, theme, theme_recipe, recipe_ingr, recipe_eq, expertise;

-- Re-enable foreign key checks after operations
SET FOREIGN_KEY_CHECKS = 1;

-- Drop the database if it exists
DROP DATABASE IF EXISTS RecipeDB;

-- Create the database
CREATE DATABASE IF NOT EXISTS RecipeDB;

-- Use the created database
USE RecipeDB;

-- Drop tables if they exist to avoid errors
SET FOREIGN_KEY_CHECKS = 0;

-- Drop tables in order of dependency (least dependent first)
DROP TABLE IF EXISTS recipe_img, label_recipe, meal_recipe, steps, episode, ep_info;
DROP TABLE IF EXISTS recipe, user_table, label, meal_type;
DROP TABLE IF EXISTS ingredient, equipment;
DROP TABLE IF EXISTS images, food_group, user_group, cook, national_cuisine, theme, theme_recipe, recipe_ingr, recipe_eq, expertise;

-- Re-enable foreign key checks after operations
SET FOREIGN_KEY_CHECKS = 1;

-- Images table
CREATE TABLE images (
    image_ID INT AUTO_INCREMENT PRIMARY KEY,
    image_desc TEXT,
    image_url TEXT UNIQUE NOT NULL
) ENGINE=InnoDB;

-- Food Group table
CREATE TABLE food_group (
    food_group_ID INT AUTO_INCREMENT PRIMARY KEY,
    image_ID INT NOT NULL UNIQUE,
    food_group_name VARCHAR(255) NOT NULL UNIQUE,
    food_group_desc TEXT,
    category VARCHAR(255) NOT NULL,
    INDEX fk_image_id_idx (image_ID),
    FOREIGN KEY (image_ID) REFERENCES images(image_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- Ingredients table 
CREATE TABLE ingredient (
    ingredient_ID INT AUTO_INCREMENT PRIMARY KEY,
    food_group_ID INT NOT NULL UNIQUE,
    image_ID INT NOT NULL UNIQUE,
    ingr_name VARCHAR(255) NOT NULL UNIQUE,
    calories DECIMAL(10, 2) NOT NULL CHECK(calories >= 0 AND calories <= 1000),
    unit ENUM('mL', 'L', 'g', 'table spoon', 'tea spoon', 'N/A'),
    UNIQUE INDEX ingr_group_image_idx (ingredient_ID, food_group_ID, image_ID),
    FOREIGN KEY (image_ID) REFERENCES images(image_ID) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (food_group_ID) REFERENCES food_group(food_group_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- Equipment table
CREATE TABLE equipment (
    eq_ID INT AUTO_INCREMENT PRIMARY KEY,
    image_ID INT NOT NULL UNIQUE,
    eq_name VARCHAR(255) NOT NULL UNIQUE,
    instructions TEXT NOT NULL,
    INDEX fk_image_id_idx (image_ID),
    FOREIGN KEY (image_ID) REFERENCES images(image_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- Meal Type table
CREATE TABLE meal_type (
    meal_type_ID INT AUTO_INCREMENT PRIMARY KEY,
    meal_type_name ENUM('breakfast', 'lunch', 'dinner', 'snack', 'dessert') NOT NULL
) ENGINE=InnoDB;

-- Cook table
CREATE TABLE cook (
    cook_ID INT AUTO_INCREMENT PRIMARY KEY,
    image_ID INT UNIQUE,
    firstname VARCHAR(255) NOT NULL,
    lastname VARCHAR(255) NOT NULL,
    phone_number VARCHAR(20) NOT NULL UNIQUE,
    date_of_birth DATE NOT NULL, 
    age INT NOT NULL CHECK(age >= 18 AND age <= 100),
    experience INT NOT NULL CHECK(experience >= 0 AND experience <= 100),  
    rank ENUM('cook C', 'cook B', 'cook A', 'assistant chef', 'chef') NOT NULL,
    INDEX fk_image_id_idx (image_ID),
    FOREIGN KEY (image_ID) REFERENCES images(image_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- National Cuisine table
CREATE TABLE national_cuisine (
    national_cuisine_ID INT AUTO_INCREMENT PRIMARY KEY,
    cuisine_name VARCHAR(255)
) ENGINE=InnoDB;

-- Recipes table
CREATE TABLE recipe (
    recipe_ID INT AUTO_INCREMENT PRIMARY KEY,
    national_cuisine_ID INT NOT NULL,
    main_ingredient_ID INT NOT NULL,
    recipe_name VARCHAR(255) NOT NULL UNIQUE,
    difficulty_level INT NOT NULL CHECK(difficulty_level >= 1 AND difficulty_level <= 5),
    recipe_description TEXT NOT NULL UNIQUE,
    prep_time INT NOT NULL CHECK(prep_time >= 0),
    cook_time INT NOT NULL CHECK(cook_time >= 0),
    portions INT NOT NULL CHECK(portions >= 1),
    tip_1 TEXT,
    tip_2 TEXT,
    tip_3 TEXT,
    fat DECIMAL(10, 1) NOT NULL,
    carbs DECIMAL(10, 1) NOT NULL,
    proteins DECIMAL(10, 1) NOT NULL,
    calories DECIMAL(10, 2) NOT NULL,
    CONSTRAINT t1_not_t2 CHECK (tip_1 <> tip_2),
    CONSTRAINT t1_not_t3 CHECK (tip_1 <> tip_3),
    CONSTRAINT t3_not_t2 CHECK (tip_2 <> tip_3),
    UNIQUE INDEX recipe_cuisine_main_ingr (recipe_ID, national_cuisine_ID, main_ingredient_ID),
    INDEX fk_main_ingredient_ID (main_ingredient_ID),
    INDEX national_cuisine_ID (national_cuisine_ID),
    FOREIGN KEY (national_cuisine_ID) REFERENCES national_cuisine(national_cuisine_ID) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (main_ingredient_ID) REFERENCES ingredient(ingredient_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- Meal Type Recipes table
CREATE TABLE meal_recipe (
    meal_type_ID INT NOT NULL,
    recipe_ID INT NOT NULL,
    PRIMARY KEY (meal_type_ID, recipe_ID),
    -- UNIQUE INDEX 'meal_type_recipe_idx' ('meal_type_ID' ASC, 'recipe_ID' ASC),
    FOREIGN KEY (meal_type_ID) REFERENCES meal_type(meal_type_ID) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (recipe_ID) REFERENCES recipe(recipe_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- Labels table
CREATE TABLE label (
    label_ID INT AUTO_INCREMENT PRIMARY KEY,
    label_description TEXT NOT NULL
) ENGINE=InnoDB;

-- Label Recipes table
CREATE TABLE label_recipe (
    label_ID INT NOT NULL,
    recipe_ID INT NOT NULL,
    PRIMARY KEY (label_ID, recipe_ID),
    -- UNIQUE INDEX 'label_recipe_idx' ('label_ID' ASC, 'recipe_ID' ASC),
    FOREIGN KEY (label_ID) REFERENCES label(label_ID) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (recipe_ID) REFERENCES recipe(recipe_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- Steps table
CREATE TABLE steps (
    step_ID INT AUTO_INCREMENT PRIMARY KEY,
    recipe_ID INT NOT NULL,
    sequence_number INT NOT NULL,
    step_description TEXT NOT NULL,
    UNIQUE INDEX steps_recipe (step_ID, recipe_ID),
    FOREIGN KEY (recipe_ID) REFERENCES recipe(recipe_ID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB;

-- User table
CREATE TABLE user_table (
    user_ID INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    group_name ENUM('user', 'admin') NOT NULL DEFAULT 'user',
    user_password CHAR(64) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- Episodes table
CREATE TABLE episode (
    ep_ID INT AUTO_INCREMENT PRIMARY KEY,
    image_ID INT NOT NULL,
    judge_1 INT NOT NULL,
    judge_2 INT NOT NULL,
    judge_3 INT NOT NULL,
    season INT NOT NULL CHECK(season >= 1),
    episode INT NOT NULL CHECK(episode >= 1 AND episode <= 10),
    INDEX fk_image_ID_idx (image_ID),
    INDEX fk_judge_1_idx (judge_1),
    INDEX fk_judge_2_idx (judge_2),
    INDEX fk_j
